<!doctype html>
<html lang=en>
<head>
    <title>Ryke Carleton Exploration tool</title>
    <meta charset=utf-8/>
    <meta name=viewport content='user-scalable=no,width=device-width,maximum-scale=1.0,minimum-scale=1.0'/>
</head>
<body>
<script src="https://js.leapmotion.com/leap-0.6.4.js"></script>
<script src="https://mrdoob.github.io/three.js/examples/js/libs/stats.min.js"></script>
<script src="https://mrdoob.github.io/three.js/build/three.min.js"></script>
<script src="https://mrdoob.github.io/three.js/examples/js/controls/OrbitControls.js"></script>
<script src="https://mrdoob.github.io/three.js/examples/js/loaders/ColladaLoader.js"></script>
<script src="https://mrdoob.github.io/three.js/examples/js/loaders/OBJLoader.js"></script>
<script src="https://mrdoob.github.io/three.js/examples/js/loaders/collada/Animation.js"></script>
<script src="https://mrdoob.github.io/three.js/examples/js/loaders/collada/AnimationHandler.js"></script>
<script src="https://mrdoob.github.io/three.js/examples/js/loaders/collada/KeyFrameAnimation.js"></script>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script type="text/javascript" src="QuadCalculator.js"></script>
<script>
    var x = 0, y = -1000, z = 100, id = Date.now() ;
    var players = [];
    var info, stats, socket, renderer, scene, camera, controls, light, yllwStrc = false, lastSend = Date.now();

    class Player {
        constructor(scene, id)
        {
            this.scene = scene;
            this.id = id;
            this.airplane = false;
            this.draw(id);
        }

        setCords(x, y, z, phi)
        {
            if (this.airplane == false) return;
            this.airplane.position.x = x;
            this.airplane.position.y = y;
            this.airplane.position.z = z;
            if (phi) {
              this.airplane.rotation.z = phi + Math.PI/2;
            }
        }

        destroy() {
          scene.remove( this.airplane );
        }

        draw(id)
        {
            // initialise loaders
            var colladaLoader = new THREE.ColladaLoader();

            // add university to the model
            colladaLoader.load('resources/airplane.dae', function (collada) {
                this.scene.add(collada.scene);
                this.airplane = collada.scene;
                this.airplane.name = `${id}`;
            }.bind(this))
        }
    }




    function init() {
        renderer = new THREE.WebGLRenderer({antialias: true, alpha: 1, clearColor: 0xffffff});
        renderer.shadowMap.enabled = true;
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        scene = new THREE.Scene();
        // Alerts have been activated
        var yllwStrc = false;
        var ghandi = false;

        document.body.style.backgroundColor = "lightBlue";

        addUniversity(scene);


        var light = new THREE.PointLight(0xffffff);
        light.position.set(-100, 200, 100);
        scene.add(light);

        light = new THREE.PointLight(0xffffff);
        light.position.set(x, y, z);
        scene.add(light);

        var loader = new THREE.TextureLoader();

        // Create a grass field
        var material = new THREE.MeshBasicMaterial({
            color: "green"
        });
        var geometry = new THREE.PlaneGeometry(12000, 11000);
        var plane = new THREE.Mesh(geometry, material);
        plane.rotation.z = Math.PI / 8;
        plane.position.x = -20;
        plane.position.y = 65;
        plane.position.z = -1;
        scene.add(plane);

        // load a resource
        loader.load(
            // resource URL
            'resources/surface2.png',
            // Function when resource is loaded
            function (texture) {
                // do something with the texture


                var material = new THREE.MeshBasicMaterial({
                    map: texture
                });
                var geometry = new THREE.PlaneGeometry(1100, 1200);
                var plane = new THREE.Mesh(geometry, material);
                plane.rotation.z = Math.PI / 60;
                plane.position.x = -80;
                plane.position.y = -50;
                scene.add(plane);


            },
            // Function called when download progresses
            function (xhr) {
                console.log((xhr.loaded / xhr.total * 100) + '% loaded');
            },
            // Function called when download errors
            function (xhr) {
                console.log('An error happened');
            }
        );

        var axisHelper = new THREE.AxisHelper(1000);
        scene.add(axisHelper);
        camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 5000);
        camera.position.set(x, y, z);
        controls = new THREE.OrbitControls(camera, renderer.domElement);

        Leap.loop({}, function (frame) {
            update_state(frame);
            camera.position.x = state.location.x;
            camera.position.y = state.location.y;
            camera.position.z = state.location.z;
            light.position.set(camera.position.x, camera.position.y, camera.position.z);
            camera.rotation.y = state.direction.spherical.phi;
            camera.rotation.x = Math.PI / 2;
            // + Math.cos(state.direction.spherical.phi) * state.direction.spherical.theta / 3;
            camera.rotation.z = 0; // + Math.sin(state.direction.spherical.phi) * state.direction.spherical.theta / 3;

            if (Date.now() - lastSend > 100) {
              lastSend = Date.now();
              sendLocation();
            }

            if ((camera.position.x > -225) && (camera.position.x < -195) && (camera.position.y > -85) &&
              (camera.position.y < -55) && (yllwStrc === false)) {
                yllwStrc = true;
                alert("Yellow Structure, by Civils, for Civils.");
            }
            if ((camera.position.x > -95) && (camera.position.x < -75) && (camera.position.y > -330) &&
                (camera.position.y < -310) && (ghandi === false)) {
                ghandi = true;
                alert("Ghandi.");
            }
        });
        function render() {
            requestAnimationFrame(render);
            renderer.render(scene, camera);
        }

        render();
        //controls.update();
        Leap.loopController.setBackground(true);
    }

    function initSocket() {
      socket = new io('http://ryke.xyz', {resource: 'socket'});
      console.log("Started connection")
    }

    function sendLocation() {
      socket.emit('new location', {id, x: state.location.x, y: state.location.y, z:
      state.location.z, phi: state.direction.spherical.phi});
    }

    function onNewLocation(location) {
      if (id == location.id) return;
      let player = players[location.id];
      if (!player) {
        console.log("Created player");
        player = new Player(scene, location.id);
        players[location.id] = player;
      }
      player.setCords(location.x, location.y, location.z, location.phi)
    }

    function registerSocketListeners() {
      socket.on('new location', onNewLocation);
      socket.on('user left', (data) => {
        console.log("got user left", data);
        let player = players[data.id];
        if (player) {
          console.log("Unloading player ", data.id);
          player.destroy();
        }
      })
    }

    function addUniversity(scene){
        // initialise loaders
        var colladaLoader = new THREE.ColladaLoader();

        // add university to the model
        colladaLoader.load('resources/CarletonUniversity5.dae', function (collada) {
          scene.add(collada.scene);
        });
    }

    init();
    initSocket();
    registerSocketListeners();
</script>
</body>
</html>